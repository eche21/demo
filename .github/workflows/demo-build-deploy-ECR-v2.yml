###########################################################################################
# THIS DEMO SUCCESSFULLY BUILDS AND DEPLOYS THE DOCKER CONTAINER TO AKS
#THE APP IS TAKEN FROM docs.docker.com/get-started/02_our_app
#THE ZIP FOLDER IS IN MY DOWNLOADS C:\Users\ericn\Downloads\getting-started-master.zip
#########################################################################################
#
#This workflow is triggered on a push to github branch che
name: demo_build_and_deploy_ECR

on:
  push:
    branches: [ cheECR ]
    paths-ignore:
      - demo-build-deploy-v1.yml
      - demo-build-deploy-v2.yml
      - demo-build-deploy-v3.yml
      - demo-build-deploy.yml 


jobs:

  build-deploy-to-ECR:
    runs-on: ubuntu-latest
    env:
      #Environment variables for Docker image
      DOCKER_REPOSITORY: eche21 # name of Docker Hub ID
      IMAGE_NAME: demoappv4 # name of image
      IMAGE_TAG: ${{ github.sha }} # $GITHUB_SHA the  commit ID
      #

    
    steps:
    - name: Git Checkout
      uses: actions/checkout@v2
    # - name: Build Docker Image
    #   run:
    #      docker build ./app/ --file ./app/Dockerfile --tag $DOCKER_REPOSITORY/$IMAGE_NAME:$GITHUB_SHA --build-arg=token=secrets.MYTOKEN --no-cache

    # - name: Login to Docker Hub
    #   run: |
    #      echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u $DOCKER_REPOSITORY --password-stdin

    # - name: Push Image to Docker Hub
    #   run:
    #      docker push $DOCKER_REPOSITORY/$IMAGE_NAME:$GITHUB_SHA
    - name: Docker Login
      uses: docker/login-action@v1.14.1
      with:
        username: ${{ secrets.DOCKER_REPOSITORY }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    - name: Build and push Image to DockerHub
      uses: docker/build-push-action@v2.10.0
      with:
        context: './demo'
        file: 'app/Dockerfile'
        push: true
        tags: ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
