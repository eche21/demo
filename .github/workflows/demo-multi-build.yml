###########################################################################################
# THIS DEMO SUCCESSFULLY BUILDS AND DEPLOYS THE DOCKER CONTAINER TO AKS
#THE APP IS TAKEN FROM docs.docker.com/get-started/02_our_app
#THE ZIP FOLDER IS IN MY DOWNLOADS C:\Users\ericn\Downloads\getting-started-master.zip
#########################################################################################
#
#This workflow is triggered on a push to github branch che
name: demo_multi_build
on:
  push:
    branches:
      - echemultiplatform     

jobs:

  build-multi-platform:
    runs-on: ubuntu-latest
    env:
      #Environment variables for Docker image
#      DOCKER_REPOSITORY: eche21 # name of Docker Hub ID
      IMAGE_NAME: eche21/demoappv3 # name of image
      IMAGE_TAG: ${{ github.sha }} # $GITHUB_SHA the  commit ID
      #
      #variables for AKS cluster and namespace
      CLUSTER_NAME: RegScale
      CLUSTER_RESOURCE_GROUP: Corporate
      NAMESPACE: demo-eche
     #

    steps:
#    
    - name: Git checkout
      uses: actions/checkout@v3
#  
    - name: shortsha
      run:        echo "IMAGE_TAG=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV 
#This step builds the docker image using docker build. The image is tagged.
# We can also use a step predefined in github market place.
# But we use the command line. The docker cli and the docker daemon are already installed inside  the runner. 
#This gives more flexibility and more control.
#
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD}}
    -
        name: Build and push
        uses: docker/build-push-action@v3
        with:
          context: ./app
          push: true
          tags: $IMAGE_NAME:0.0.1
    # - name: Build Docker Image
    #   run: |
    #     docker build ./app/ --file ./app/Dockerfile --tag $DOCKER_REPOSITORY/$IMAGE_NAME:$SHORT_SHA --build-arg=token=secrets.MYTOKEN --no-cache

    # - name: list existing builders
    #   run: docker images